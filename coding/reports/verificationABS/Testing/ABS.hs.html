<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
span.lineno { color: white; background: #aaaaaa; border-right: solid white 12px }
span.nottickedoff { background: yellow}
span.istickedoff { background: white }
span.tickonlyfalse { margin: -1px; border: 1px solid #f20913; background: #f20913 }
span.tickonlytrue  { margin: -1px; border: 1px solid #60de51; background: #60de51 }
span.funcount { font-size: small; color: orange; z-index: 2; position: absolute; right: 20 }
span.decl { font-weight: bold }
span.spaces    { background: white }
</style>
</head>
<body>
<pre>
<span class="lineno">    1 </span>{-# LANGUAGE Arrows #-}
<span class="lineno">    2 </span>module ABS
<span class="lineno">    3 </span>  (
<span class="lineno">    4 </span>    SIRState (..)
<span class="lineno">    5 </span>
<span class="lineno">    6 </span>  , runABS
<span class="lineno">    7 </span>
<span class="lineno">    8 </span>  , susceptibleAgent
<span class="lineno">    9 </span>  , infectedAgent
<span class="lineno">   10 </span>  ) where
<span class="lineno">   11 </span>
<span class="lineno">   12 </span>import Control.Monad.Random
<span class="lineno">   13 </span>import FRP.Yampa
<span class="lineno">   14 </span>
<span class="lineno">   15 </span>import SIR
<span class="lineno">   16 </span>
<span class="lineno">   17 </span>data SIRState 
<span class="lineno">   18 </span>  = Susceptible 
<span class="lineno">   19 </span>  | Infected 
<span class="lineno">   20 </span>  | Recovered 
<span class="lineno">   21 </span>  deriving (<span class="decl"><span class="nottickedoff"><span class="decl"><span class="nottickedoff">Show</span></span></span></span>, <span class="decl"><span class="istickedoff"><span class="decl"><span class="nottickedoff">Eq</span></span></span></span>)
<span class="lineno">   22 </span>
<span class="lineno">   23 </span>type SIRAgent = SF [SIRState] SIRState
<span class="lineno">   24 </span>
<span class="lineno">   25 </span>runABS :: RandomGen g 
<span class="lineno">   26 </span>       =&gt; g 
<span class="lineno">   27 </span>       -&gt; Int
<span class="lineno">   28 </span>       -&gt; Int
<span class="lineno">   29 </span>       -&gt; Time 
<span class="lineno">   30 </span>       -&gt; DTime 
<span class="lineno">   31 </span>       -&gt; [(Double, Double, Double)]
<span class="lineno">   32 </span><span class="decl"><span class="istickedoff">runABS g populationSize infectedCount t dt</span>
<span class="lineno">   33 </span><span class="spaces">    </span><span class="istickedoff">= aggregateAllStates $ runSimulation g t dt as</span>
<span class="lineno">   34 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">   35 </span><span class="spaces">    </span><span class="istickedoff">as = initAgents populationSize infectedCount</span></span>
<span class="lineno">   36 </span>
<span class="lineno">   37 </span>aggregateAllStates :: [[SIRState]] -&gt; [(Double, Double, Double)]
<span class="lineno">   38 </span><span class="decl"><span class="istickedoff">aggregateAllStates = map aggregateStates</span></span>
<span class="lineno">   39 </span>
<span class="lineno">   40 </span>aggregateStates :: [SIRState] -&gt; (Double, Double, Double)
<span class="lineno">   41 </span><span class="decl"><span class="istickedoff">aggregateStates as = (susceptibleCount, infectedCount, recoveredCount)</span>
<span class="lineno">   42 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">   43 </span><span class="spaces">    </span><span class="istickedoff">susceptibleCount = fromIntegral $ length $ filter (Susceptible==) as</span>
<span class="lineno">   44 </span><span class="spaces">    </span><span class="istickedoff">infectedCount = fromIntegral $ length $ filter (Infected==) as</span>
<span class="lineno">   45 </span><span class="spaces">    </span><span class="istickedoff">recoveredCount = fromIntegral $ length $ filter (Recovered==) as</span></span>
<span class="lineno">   46 </span>
<span class="lineno">   47 </span>runSimulation :: RandomGen g 
<span class="lineno">   48 </span>              =&gt; g 
<span class="lineno">   49 </span>              -&gt; Time 
<span class="lineno">   50 </span>              -&gt; DTime 
<span class="lineno">   51 </span>              -&gt; [SIRState] 
<span class="lineno">   52 </span>              -&gt; [[SIRState]]
<span class="lineno">   53 </span><span class="decl"><span class="istickedoff">runSimulation g t dt as = embed (stepSimulation sfs as) ((), dts)</span>
<span class="lineno">   54 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">   55 </span><span class="spaces">    </span><span class="istickedoff">steps = floor $ t / dt</span>
<span class="lineno">   56 </span><span class="spaces">    </span><span class="istickedoff">dts = replicate steps (dt, Nothing) -- keep input the same as initial one, will be ignored anyway</span>
<span class="lineno">   57 </span><span class="spaces">    </span><span class="istickedoff">n = length as</span>
<span class="lineno">   58 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">   59 </span><span class="spaces">    </span><span class="istickedoff">(rngs, _) = rngSplits g n []</span>
<span class="lineno">   60 </span><span class="spaces">    </span><span class="istickedoff">sfs = zipWith sirAgent rngs as</span>
<span class="lineno">   61 </span><span class="spaces">    </span><span class="istickedoff"></span>
<span class="lineno">   62 </span><span class="spaces">    </span><span class="istickedoff">rngSplits :: RandomGen g =&gt; g -&gt; Int -&gt; [g] -&gt; ([g], g)</span>
<span class="lineno">   63 </span><span class="spaces">    </span><span class="istickedoff">rngSplits g 0 acc = (acc, <span class="nottickedoff">g</span>)</span>
<span class="lineno">   64 </span><span class="spaces">    </span><span class="istickedoff">rngSplits g n acc = rngSplits g'' (n-1) (g' : acc)</span>
<span class="lineno">   65 </span><span class="spaces">      </span><span class="istickedoff">where</span>
<span class="lineno">   66 </span><span class="spaces">        </span><span class="istickedoff">(g', g'') = split g</span></span>
<span class="lineno">   67 </span>
<span class="lineno">   68 </span>stepSimulation :: [SIRAgent] -&gt; [SIRState] -&gt; SF () [SIRState]
<span class="lineno">   69 </span><span class="decl"><span class="istickedoff">stepSimulation sfs as =</span>
<span class="lineno">   70 </span><span class="spaces">    </span><span class="istickedoff">pSwitch</span>
<span class="lineno">   71 </span><span class="spaces">      </span><span class="istickedoff">(\_ sfs' -&gt; (map (\sf -&gt; (as, sf)) sfs'))</span>
<span class="lineno">   72 </span><span class="spaces">      </span><span class="istickedoff">sfs</span>
<span class="lineno">   73 </span><span class="spaces">      </span><span class="istickedoff">-- if we switch immediately we end up in endless switching, so always wait for 'next'</span>
<span class="lineno">   74 </span><span class="spaces">      </span><span class="istickedoff">(switchingEvt &gt;&gt;&gt; notYet) </span>
<span class="lineno">   75 </span><span class="spaces">      </span><span class="istickedoff">stepSimulation</span>
<span class="lineno">   76 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">   77 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">   78 </span><span class="spaces">    </span><span class="istickedoff">switchingEvt :: SF ((), [SIRState]) (Event [SIRState])</span>
<span class="lineno">   79 </span><span class="spaces">    </span><span class="istickedoff">switchingEvt = arr (\(_, newAs) -&gt; Event newAs)</span></span>
<span class="lineno">   80 </span>
<span class="lineno">   81 </span>sirAgent :: RandomGen g =&gt; g -&gt; SIRState -&gt; SIRAgent
<span class="lineno">   82 </span><span class="decl"><span class="istickedoff">sirAgent g Susceptible = susceptibleAgent g</span>
<span class="lineno">   83 </span><span class="spaces"></span><span class="istickedoff">sirAgent g Infected    = infectedAgent g</span>
<span class="lineno">   84 </span><span class="spaces"></span><span class="istickedoff">sirAgent _ Recovered   = <span class="nottickedoff">recoveredAgent</span></span></span>
<span class="lineno">   85 </span>
<span class="lineno">   86 </span>susceptibleAgent :: RandomGen g 
<span class="lineno">   87 </span>                 =&gt; g 
<span class="lineno">   88 </span>                 -&gt; SIRAgent
<span class="lineno">   89 </span><span class="decl"><span class="istickedoff">susceptibleAgent g = </span>
<span class="lineno">   90 </span><span class="spaces">    </span><span class="istickedoff">switch </span>
<span class="lineno">   91 </span><span class="spaces">      </span><span class="istickedoff">(susceptible g) </span>
<span class="lineno">   92 </span><span class="spaces">      </span><span class="istickedoff">(const $ infectedAgent g)</span>
<span class="lineno">   93 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">   94 </span><span class="spaces">    </span><span class="istickedoff">susceptible :: RandomGen g =&gt; g -&gt; SF [SIRState] (SIRState, Event ())</span>
<span class="lineno">   95 </span><span class="spaces">    </span><span class="istickedoff">susceptible g = proc as -&gt; do</span>
<span class="lineno">   96 </span><span class="spaces">      </span><span class="istickedoff">makeContact &lt;- occasionally g (1 / contactRate) <span class="nottickedoff">()</span> -&lt; <span class="nottickedoff">()</span></span>
<span class="lineno">   97 </span><span class="spaces"></span><span class="istickedoff"></span>
<span class="lineno">   98 </span><span class="spaces">      </span><span class="istickedoff">-- NOTE: strangely if we are not splitting all if-then-else into</span>
<span class="lineno">   99 </span><span class="spaces">      </span><span class="istickedoff">-- separate but only a single one, then it seems not to work,</span>
<span class="lineno">  100 </span><span class="spaces">      </span><span class="istickedoff">-- dunno why</span>
<span class="lineno">  101 </span><span class="spaces">      </span><span class="istickedoff">if isEvent makeContact</span>
<span class="lineno">  102 </span><span class="spaces">        </span><span class="istickedoff">then (do</span>
<span class="lineno">  103 </span><span class="spaces">          </span><span class="istickedoff">a &lt;- drawRandomElemSF g -&lt; as</span>
<span class="lineno">  104 </span><span class="spaces">          </span><span class="istickedoff">case a of</span>
<span class="lineno">  105 </span><span class="spaces">            </span><span class="istickedoff">Just Infected -&gt; do</span>
<span class="lineno">  106 </span><span class="spaces">              </span><span class="istickedoff">i &lt;- randomBoolSF g infectivity -&lt; <span class="nottickedoff">()</span></span>
<span class="lineno">  107 </span><span class="spaces">              </span><span class="istickedoff">if i</span>
<span class="lineno">  108 </span><span class="spaces">                </span><span class="istickedoff">then returnA -&lt; (<span class="nottickedoff">Infected</span>, Event <span class="nottickedoff">()</span>)</span>
<span class="lineno">  109 </span><span class="spaces">                </span><span class="istickedoff">else returnA -&lt; (Susceptible, NoEvent)</span>
<span class="lineno">  110 </span><span class="spaces">            </span><span class="istickedoff">_       -&gt; returnA -&lt; (Susceptible, NoEvent))</span>
<span class="lineno">  111 </span><span class="spaces">        </span><span class="istickedoff">else returnA -&lt; (Susceptible, NoEvent)</span></span>
<span class="lineno">  112 </span>
<span class="lineno">  113 </span>infectedAgent :: RandomGen g =&gt; g -&gt; SIRAgent
<span class="lineno">  114 </span><span class="decl"><span class="istickedoff">infectedAgent g = </span>
<span class="lineno">  115 </span><span class="spaces">    </span><span class="istickedoff">switch </span>
<span class="lineno">  116 </span><span class="spaces">      </span><span class="istickedoff">infected </span>
<span class="lineno">  117 </span><span class="spaces">      </span><span class="istickedoff">(const recoveredAgent)</span>
<span class="lineno">  118 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  119 </span><span class="spaces">    </span><span class="istickedoff">infected :: SF [SIRState] (SIRState, Event ())</span>
<span class="lineno">  120 </span><span class="spaces">    </span><span class="istickedoff">infected = proc _ -&gt; do</span>
<span class="lineno">  121 </span><span class="spaces">      </span><span class="istickedoff">recEvt &lt;- occasionally g illnessDuration <span class="nottickedoff">()</span> -&lt; <span class="nottickedoff">()</span></span>
<span class="lineno">  122 </span><span class="spaces">      </span><span class="istickedoff">let a = event Infected <span class="nottickedoff">(const Recovered)</span> recEvt</span>
<span class="lineno">  123 </span><span class="spaces">      </span><span class="istickedoff">returnA -&lt; (a, recEvt)</span></span>
<span class="lineno">  124 </span>
<span class="lineno">  125 </span>recoveredAgent :: SIRAgent
<span class="lineno">  126 </span><span class="decl"><span class="istickedoff">recoveredAgent = arr (const Recovered)</span></span>
<span class="lineno">  127 </span>
<span class="lineno">  128 </span>randomBoolSF :: RandomGen g =&gt; g -&gt; Double -&gt; SF () Bool
<span class="lineno">  129 </span><span class="decl"><span class="istickedoff">randomBoolSF g p = proc _ -&gt; do</span>
<span class="lineno">  130 </span><span class="spaces">  </span><span class="istickedoff">r &lt;- noiseR ((0, 1) :: (Double, Double)) g -&lt; <span class="nottickedoff">()</span></span>
<span class="lineno">  131 </span><span class="spaces">  </span><span class="istickedoff">returnA -&lt; (r &lt;= p)</span></span>
<span class="lineno">  132 </span>
<span class="lineno">  133 </span>drawRandomElemSF :: RandomGen g =&gt; g -&gt; SF [a] (Maybe a)
<span class="lineno">  134 </span><span class="decl"><span class="istickedoff">drawRandomElemSF g = proc as -&gt; </span>
<span class="lineno">  135 </span><span class="spaces">  </span><span class="istickedoff">if null as </span>
<span class="lineno">  136 </span><span class="spaces">    </span><span class="istickedoff">then returnA -&lt; Nothing</span>
<span class="lineno">  137 </span><span class="spaces">    </span><span class="istickedoff">else do</span>
<span class="lineno">  138 </span><span class="spaces">      </span><span class="istickedoff">r &lt;- noiseR ((0, 1) :: (Double, Double)) g -&lt; <span class="nottickedoff">()</span></span>
<span class="lineno">  139 </span><span class="spaces">      </span><span class="istickedoff">let len = length as</span>
<span class="lineno">  140 </span><span class="spaces">      </span><span class="istickedoff">let idx = fromIntegral len * r</span>
<span class="lineno">  141 </span><span class="spaces">      </span><span class="istickedoff">let a =  as !! floor idx</span>
<span class="lineno">  142 </span><span class="spaces">      </span><span class="istickedoff">returnA -&lt; Just a</span></span>
<span class="lineno">  143 </span>
<span class="lineno">  144 </span>initAgents :: Int -&gt; Int -&gt; [SIRState]
<span class="lineno">  145 </span><span class="decl"><span class="istickedoff">initAgents n i = sus ++ inf</span>
<span class="lineno">  146 </span><span class="spaces">  </span><span class="istickedoff">where</span>
<span class="lineno">  147 </span><span class="spaces">    </span><span class="istickedoff">sus = replicate (n - i) Susceptible</span>
<span class="lineno">  148 </span><span class="spaces">    </span><span class="istickedoff">inf = replicate i Infected</span></span>

</pre>
</body>
</html>
