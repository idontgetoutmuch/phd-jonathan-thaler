\section{Case Study I: SIR}
\label{sec:case_SIR}
As first use-case we discuss property-based testing for the \textit{explanatory} agent-based SIR model as introduced in Chapter \ref{sec:sir_model}. 

Our goal is to connect the agent-based implementation to the SD equations, which we repeat here:

\begin{equation}
\begin{split}
\frac{\mathrm d S}{\mathrm d t} = -infectionRate \\
\frac{\mathrm d I}{\mathrm d t} = infectionRate - recoveryRate \\
\frac{\mathrm d R}{\mathrm d t} = recoveryRate 
\end{split}
\quad
\begin{split}
infectionRate = \frac{I \beta S \gamma}{N} \\
recoveryRate = \frac{I}{\delta} 
\end{split}
\end{equation}

The idea is to generate random population mixes and compute the theoretical infection- and recovery rate. Then the simulation is run for 1 time unit to get the numbers of S, I and R. We compare the differences to the expected infection and recovery rate. The distribution should average at the expected theoretical means. TODO: use Rand approach to guarantee uncorrelated RNGS. Note that we need to run the whole test multiple times with different rngs because it is a  

can we really do it? is it really possible to compare SD and agent-based simulation? 

TODO: a bit more than 1000 seconds for 100 tests

TODO: can use this test to derive an optimally small dt: the lowest dt for which all tests go through. start with 1.0 and always half it until all tests go through

By using quickcheck we showed how to connect the ABS implementation to the SD specification by deriving properties based on the SD specification. those properties are directly expressed in code and checked during testing by generating random populations. In each test-case of a random population we run 100 replications of the simulation. On these 100 samples we then perform a 2-sided t-test with the null hypothesis H0 that the mean of the samples is equal to the expected number of susceptibles, which we aim to accept.
Unfortunately, not all tests were running through, depending on the dt value for the simulation and the confidence (alpha) value for the t-test. The sensitivity to both is obvious: a small dt avoids undersampling as already shown in the chapter (TODO time-driven) and it is clear that lowering the alpha value for a t-test which aims at accepting H0 leads to a test which is more likely to accept it. Still, if we select the parameters quite conservatively to dt = 0.01 and confidence = 0.01 about 5\% of 1000 tests fail.
This fact reveals the fundamental difference between SD and ABS: due to ABS stochastic nature, an ABS cannot match an SD exactly and is much richer in its dynamics as it can explore and reveal paths which are not possible in SD. In the case of the SIR model, such an alternative path would be the recovery of the single infected agent at the beginning - this is not possible in the SD case: in case we have 1 infected agent, the whole epidemics unfold.
The difficulty of comparing dynamics between SD and ABS and the impracticality to compare them \textit{exactly} was shown by \cite{macal_agent-based_2010} (macal paper) in the case of the SIR model and more generally by \cite{figueredo_comparing_2014} (grazziela figueredeo and peer paper). Our tests only reveal that very fact that we can come quite close but can't match exactly - the confidence parameter allows us to specify the "tightness" of our tests and guarantees us at least that we come close up to some limit.
Although our initial idea of matching the ABS implementation to the SD specifications has not worked out in an exact way, we still showed a way of formalizing and expressing these relations in code and testing them using quickcheck. Due to the "softness" of the tests through the confidence parameter, we can show that this specification comes close to the original SD implementation but does not match it exactly and is indeed richer in its dynamics as the above mentioned papers have already shown.
Also our approach might work out better for a different model, which has a better behaved underlying specification than the bimodal SIR.

\subsection{TODO: Stateful testing of event-driven SIR}