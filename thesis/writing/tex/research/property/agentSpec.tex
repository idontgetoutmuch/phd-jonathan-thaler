\chapter{Testing agent specifications}
\label{ch:agentspec}

In this chapter we are showing how to use QuickCheck to encode full agent specifications directly in code as property tests of both time- and event-driven implementations of the agent-based SIR model. These properties serve as formal specification and tests at the same time which is a fundamental strength of property-based testing, not possible with unit testing in this strong expressive form. Besides the high expressivity, QuickCheck also allows us to state statistical coverage for certain cases, which allows to express statistical properties of the agents behaviour, something also not directly possible with unit testing. This is a very strong indication that property-based testing is a natural fit to test ABS.

\input{./tex/research/property/agentSpecEvent.tex}

\input{./tex/research/property/agentSpecTime.tex}

\section{Discussion}
In this section we have shown how to express the specifications of both the event- and time-driven agent behaviour directly in code as properties and how to implement property tests in QuickCheck for them. The approach to event-driven properties was to establish a correspondence between an input event the current agent state and the output events and the new agents state. In case of the time-driven agent, the properties are expressed in terms of a potentially infinite stream of agent output states. Although both implementations follow the same underlying model, the technical details of the properties differ substantially. The reason for this is that although property-based testing is a black-box verification technique, the implementation often requires substantial knowledge of the internal details as can be seen especially in the event-driven case.

The resulting properties are highly expressive due to pattern matching and declarative programming and can be regarded as a kind of formal specification. Together with the properties which check the state transition probabilities, we claim that the property tests shown in this chapter fully specify both the event- and time-driven agent behaviour. This is a first example emphasising the usefulness of QuickCheck for testing ABS, providing a first strong evidence for the hypothesis that randomised property testing is a good match for testing ABS.

%- time-driven is rather straight forward: just feed the population and increment the time, the agents are much more a black-box than in the event-driven approach, where there is much revealed about their inner workings through the events, thus we have to be much more explicit in event-driven. Note that we were not able to state a coverage for the infection of susceptible agents because the distribution is bimodal due to the combined probabliities of the exponential and uniform distriubtion. In event-driven we were able to state a coverage because we decoupled the process of making contact from infection: the makeContact events followed a uniform distribution as well, generated by oureselves, so we could state an expected coverage.

Curiously, the implementation of all the specifications and property tests has substantially more lines of code than the original implementations. However, this is not relevant here. We showed how to implement a full specification of an ABS model as a property test and we succeeded! This is definitely a strong indication that our hypothesis that randomised property-based testing is a suitable tool for testing ABS is valid. With unit tests we would be quite lost here as even for the SIR model, it is hard to enumerate all possible interactions and cases but by stating invariants as properties and generating random test cases we make sure they are checked.

We have not looked into more complex testing patterns like the synchronous agent interactions of Sugarscape. We didn't look into testing full agent and interacting agent behaviour using property tests as its complexity would justify a thesis on its own. Due to its inherent stateful nature with complex dependencies between valid states and agents actions we need a more sophisticated approach as outlined in \cite{de_vries_quickcheckstatemachine}, where the authors show how to build a meta model and commands which allow to specify properties and valid state transitions which can be generated automatically. We leave this for further research.

By exploiting lazy evaluation in the time-driven tests we scratch on what is conveniently possible in established approaches to ABS. We can let the simulation run potentially forever as in the case of the infected agent and rely on the correctness of the implementation to terminate in finite steps when consuming the potentially infinite stream.

We did not include an explicit environment in our agent specification tests and assumed a full connected network where all agents can make contact with each other. We claim that property-based testing is highly useful there as well, especially when dealing with random environments like in Sugarscape or social and random networks \cite{easley_networks_2010,jackson_social_2008}. We leave this for further research but we hypothesise that for the SIR model all properties presented here should still hold under different environments.
