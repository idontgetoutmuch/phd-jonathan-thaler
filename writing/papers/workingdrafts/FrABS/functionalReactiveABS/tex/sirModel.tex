\section{The SIR Model}
To explain the concepts of ABS and of our functional reactive approach to it, we introduce the SIR model as a motivating example. It is a very well studied and understood compartment model from epidemiology which allows to simulate the dynamics of an infectious disease spreading through a population. In this model, people in a population of size $N$ can be in either one of three states \textit{Susceptible}, \textit{Infected} or \textit{Recovered} at a particular time, where it is assumed that initially there is at least one infected person in the population. People interact with each other \textit{on average} with a given rate $\beta$ per time-unit and get infected with a given probability $\gamma$ when interacting with an infected person. When infected, a person recovers \textit{on average} after $\delta$ time-units and is then immune to further infections. An interaction between infected persons does not lead to re-infection, thus these interactions are ignored in this model. This definition gives rise to three compartments with the transitions as seen in Figure \ref{fig:sir_transitions}.

\begin{figure}
	\centering
	\includegraphics[width=.4\textwidth, angle=0]{./../shared/fig/diagrams/SIR_transitions.png}
	\caption{Transitions in the SIR compartment model.}
	\label{fig:sir_transitions}
\end{figure}

The dynamics of this model over time can be formalized using the System Dynamics (SD) approach which models a system through differential equations. For the SIR model we get the following equations:

\begin{align*}
\frac{\mathrm d S}{\mathrm d t} &= -infectionRate \\ 
\frac{\mathrm d I}{\mathrm d t} &= infectionRate - recoveryRate \\ 
\frac{\mathrm d R}{\mathrm d t} &= recoveryRate 
\end{align*}

\begin{align*}
infectionRate &= \frac{I \beta S \gamma}{N} \\
recoveryRate &= \frac{I}{\delta} 
\end{align*}

Solving these equations is then done by integrating over time. In the SD terminology, the integrals are called \textit{Stocks} and the values over which is integrated over time are called \textit{Flows} \footnote{The $1+$ in $I(t)$ amounts to the initially infected agent - if there wouldn't be a single infected one, the system would immediately reach equilibrium.}.

\begin{align*}
S(t) &= N + \int_0^t -infectionRate\, \mathrm{d}t \\
I(t) &= 1 + \int_0^t infectionRate - recoveryRate\, \mathrm{d}t \\
R(t) &= \int_0^t recoveryRate\, \mathrm{d}t
\end{align*}

There exist a huge number of software packages which allow to conveniently express SD models using a visual approach like in Figure \ref{fig:sir_sd_stockflow_diagramm}.

\begin{figure}
	\centering
	\includegraphics[width=.4\textwidth, angle=0]{./../shared/fig/diagrams/SIR_SD_STOCKFLOW_DIAGRAMM.png}
	\caption{A visual representation of the SD stocks and flows of the SIR compartment model. Picture taken using AnyLogic Personal Learning Edition 8.1.0.}
	\label{fig:sir_sd_stockflow_diagramm}
\end{figure}

Running the SD simulation over time results in the dynamics as shown in Figure \ref{fig:sir_sd_dynamics} with the given variables.

\begin{figure}
	\centering
	\includegraphics[width=.4\textwidth, angle=0]{./../shared/fig/frsd/SIR_SD_1000agents_150t_001dt.png}
	\caption{Dynamics of the SIR compartment model using the System Dynamics approach. Population Size $N$ = 1000, contact rate $\beta =  \frac{1}{5}$, infection probability $\gamma = 0.05$, illness duration $\delta = 15$ with initially 1 infected agent. Simulation run for 150 time-steps.}
	\label{fig:sir_sd_dynamics}
\end{figure}

\subsection*{An Agent-Based approach}
The SD approach is inherently top-down because the emergent property of the system is formalized in differential equations. The question is if such a top-down behaviour can be emulated using ABS, which is inherently bottom-up. Also the question is if there are fundamental drawbacks and benefits when doing so using ABS. Such questions were asked before and modelling the SIR model using an agent-based approach is indeed possible. It is important to note that SD treats the population completely continuous which results in non-discrete values of stocks e.g. 3.1415 infected persons. Thus the fundamental approach to map the SIR model to an ABS is to discretize the population and model each person in the population as an individual agent. The transition  between the states are no longer happening according to continuous differential equations but due to discrete events caused both by interactions amongst the agents and time-outs.

\begin{itemize}
	\item Every agent makes \textit{on average} contact with $\beta$ random other agents per time unit. In ABS we can only contact discrete agents thus we model this by generating a random event on average every $\beta$ time units. Note that we need to sample from an exponential CDF because the rate is proportional to the size of the population as \cite{borshchev_system_2004} pointed out.
	
	\item An agent does not know the other agents' state when making contact with it, thus we need a mechanism in which agents reveal their state in which they are in \textit{at the moment of making contact}. Obviously the already mentioned messaging which allows agents to interact is perfectly suited to do this.
	\begin{itemize}
		\item \textit{Susceptibles}: These agents make contact with other random agents (excluding themselves) with a "Susceptible" message. They can be seen to be the drivers of the dynamics.
		\item \textit{Infected}: These agents only reply to incoming "Susceptible" messages with an "Infected" message to the sender. Note that they themselves do \textit{not} make contact pro-actively but only react to incoming one. 
		\item \textit{Recovered}: These agents do not need to send messages because contacting it or being contacted by it has no influence on the state.
	\end{itemize}
	
	\item Transition of susceptible to infected state - a susceptible agent needs to have made contact with an infected agent which happens when it receives an "Infected" message. If this happens an infection occurs with a probability of $\gamma$. The infection can be calculated by drawing $p$ from a uniform random-distribution between 0 and 1 - infection occurs in case of $\gamma >= p $. Note that this needs to be done for \textit{every} received "Infected" message.
	
	\item Transition of infected to recovered - a person recovers \textit{on average} after $\delta$ time unites. This is implemented by drawing the duration from an exponential distribution \cite{borshchev_system_2004} with $\lambda = \frac{1}{\delta}$ and making the transition after this duration.
\end{itemize}

In Figure \ref{fig:sir_abs_anylogic_agents} we give the dynamics simulating the SIR model with the agent-based approach.

%TODO: replace these pictures with ones generated by FrABS
%
%TODO: reproducing about the same dynamics of the SD-solution (1.0 dt)
%	- super-sampling: 	contact-rate ss high, illness time-out low 
%	- agent number:		1000 vs. 10.000 agents
%	- Susceptibles making contact and infected response VS. only Infected make contact
%	- update-strat:		Sequential vs. Parallel
%	- making contact: susceptible only vs. susceptible AND infected
%	- do conversations make a difference?
%	- does a delayed switch (dSwitch) in transitions makes a difference?
	
\begin{figure*}
\begin{center}

	\begin{tabular}{c c c}
		\begin{subfigure}[b]{0.3\textwidth}
			\centering
			\includegraphics[width=1\textwidth, angle=0]{./../shared/fig/frabs/SIR_100agents_150t_01dt_parallel.png}
			\caption{100 Agents}
			\label{fig:pd_seq}
		\end{subfigure}
    	&
		\begin{subfigure}[b]{0.3\textwidth}
			\centering
			\includegraphics[width=1\textwidth, angle=0]{./../shared/fig/frabs/SIR_1000agents_150t_01dt_parallel.png}
			\caption{1,000 Agents}
			\label{fig:pd_seq}
		\end{subfigure}
    	&
		\begin{subfigure}[b]{0.3\textwidth}
			\centering
			\includegraphics[width=1\textwidth, angle=0]{./../shared/fig/frabs/SIR_10000agents_150t_01dt_parallel.png}
			\caption{10,000 Agents}
			\label{fig:hac_seq}
		\end{subfigure}
	\end{tabular}
	
	\caption{Approximating the continuous dynamics of the system dynamics simulation using the agent-based approach. Model-parameters are the same ($\beta = \frac{1}{5}$, $\gamma = 0.05$, $\delta = 15$ with initially 1 infected agent) except population size. All simulations run for 150 time-steps.} 
	\label{fig:sir_abs_anylogic_agents}
\end{center}
\end{figure*}

As previously mentioned the agent-based approach is a discrete one which means that with increasing number of agents, the discrete dynamics approximate the continuous dynamics of the SD simulation. Still the dynamics of 10,000 Agents do not match the dynamics of the SD simulation perfectly. This is because as opposed to the SD simulation the agent-based approach is inherently a stochastic one as we continuously draw from random-distributions which drive our state-transitions. What we see in Figure \ref{fig:sir_abs_anylogic_agents} is then just a single run where the dynamics would result in slightly different shapes when run with a different random-number generator seed. The agent-based approach thus generates a distribution of dynamics over which ones needs to average to arrive at the correct solution. This can be done using replications in which the simulation is run with the exact same parameters multiple times but each with a different random-number generator see. The resulting dynamics are then averaged and the result is then regarded as the correct dynamics.
We have done this as can be seen in Figure \ref{fig:sir_abs_agents_repls}, using 10 replications, which matches the SD dynamics to a very satisfactory level \footnote{Note that in the replications we are using 10 initially infected agents to ensure that no simulation run will terminate too early (meaning that the disease gets extinct after a few time steps) which would offset the dynamics completely. This happens due to "unlucky" random distributions which can be repaired by introducing more initially infected agents which increases the probability of spreading the disease in the very early stage of the simulation drastically. We found that when using 10 initially infected agents in a population of 10,000 (which amounts to 0.1\%) is enough to never result in an early terminating simulation. This is also a fundamental difference between SD and ABS: the dynamics of the agent-based approach can result in a wide range of scenarios which includes also the one in which the disease gets extinct in the early stages (a lucky coincidence for mankind) - this is simply not possible in the SD approach. So we can argue that ABS is much closer to reality than SD as it allows to explore alternate futures in the dynamics.}.

\begin{figure*}
\begin{center}

	\begin{tabular}{c c c}
		\begin{subfigure}[b]{0.3\textwidth}
			\centering
			\includegraphics[width=1\textwidth, angle=0]{./../shared/fig/frabs/SIR_100agents_150t_01dt_parallel_10replications.png}
			\caption{100 Agents}
			\label{fig:sir_abs_agents_repls_100}
		\end{subfigure}
    	&
		\begin{subfigure}[b]{0.3\textwidth}
			\centering
			\includegraphics[width=1\textwidth, angle=0]{./../shared/fig/frabs/SIR_1000agents_150t_01dt_parallel_10replications.png}
			\caption{1,000 Agents}
			\label{fig:sir_abs_agents_repls_1000}
		\end{subfigure}
    	&
		\begin{subfigure}[b]{0.3\textwidth}
			\centering
			\includegraphics[width=1\textwidth, angle=0]{./../shared/fig/frabs/SIR_1000agents_150t_01dt_parallel_10replications.png}
			\caption{TODO: create run with 10 replications of 10,000 Agents}
			\label{fig:sir_abs_agents_repls_10000}
		\end{subfigure}
	\end{tabular}
	
	\caption{Dynamics of Figure \ref{fig:sir_abs_anylogic_agents} averaged over 10 replications with initially 10 infected agents.} 
	\label{fig:sir_abs_agents_repls}
\end{center}
\end{figure*}

For a more in-depth introduction of how to approximate an SD model by ABS see \cite{macal_agent-based_2010} who discusses a general approach and how to compare dynamics and \cite{borshchev_system_2004} which explain the need to draw the illness-duration from an exponential-distribution.

We will derive the implementation of this approach in the next section, with the complete code provided in Appendix \ref{app:abs_code}. As will be seen our approach allows us express this behaviour very explicitly and is looking very much like a formal ABS specification of the problem. 